name: Build and Push Docker Images

on:
  push:
    branches: [ "master" ]
  schedule:
    - cron: '44 3 * * *'

env:
  REGISTRY: ghcr.io

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-images: ${{ steps.set-matrix.outputs.has-images }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Discover images
        id: set-matrix
        run: |
          echo "ðŸ” Discovering images in images/ directory..."
          
          if [ ! -d "images" ]; then
            echo "âŒ images/ directory not found"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has-images=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          images_array=()
          for dir in images/*/; do
            if [ -d "$dir" ]; then
              image_name=$(basename "$dir")
              dockerfile="$dir/Dockerfile"
              tagfile="$dir/tag"
              
              if [ ! -f "$dockerfile" ]; then
                echo "âš ï¸  Skipping $image_name: Dockerfile not found"
                continue
              fi
              
              if [ ! -f "$tagfile" ]; then
                echo "âš ï¸  Skipping $image_name: tag file not found"
                continue
              fi
              
              images_array+=("$image_name")
              echo "âœ… Found: $image_name"
            fi
          done
          
          if [ ${#images_array[@]} -eq 0 ]; then
            echo "âš ï¸  No valid images found"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has-images=false" >> $GITHUB_OUTPUT
          else
            matrix_json=$(printf '%s\n' "${images_array[@]}" | jq -R . | jq -s -c .)
            echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
            echo "has-images=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Total images to process: ${#images_array[@]}"
          fi

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.has-images == 'true'
    
    strategy:
      matrix:
        image: ${{ fromJson(needs.discover.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3
    
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare image name (lowercase)
        id: prepare
        run: |
          IMAGE_NAME="${{ matrix.image }}"
          # Convert to lowercase
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          
          # Convert repository owner to lowercase
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          echo "image_name=$IMAGE_NAME_LOWER" >> $GITHUB_OUTPUT
          echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
          echo "âœ… Image name: $IMAGE_NAME_LOWER"
          echo "âœ… Repository owner: $REPO_OWNER"

      - name: Validate image structure
        id: validate
        run: |
          IMAGE_NAME="${{ matrix.image }}"
          IMAGE_DIR="images/${IMAGE_NAME}"
          DOCKERFILE="${IMAGE_DIR}/Dockerfile"
          TAG_FILE="${IMAGE_DIR}/tag"
          
          echo "ðŸ” Validating image: $IMAGE_NAME"
          
          if [ ! -f "$DOCKERFILE" ]; then
            echo "âŒ Dockerfile not found: $DOCKERFILE"
            exit 1
          fi
          echo "âœ… Dockerfile found"
          
          if [ ! -f "$TAG_FILE" ]; then
            echo "âŒ Tag file not found: $TAG_FILE"
            exit 1
          fi
          echo "âœ… Tag file found"
          
          IMAGE_TAG=$(cat "$TAG_FILE" | tr -d '[:space:]')
          if [ -z "$IMAGE_TAG" ]; then
            echo "âŒ Tag file is empty"
            exit 1
          fi
          
          # Convert tag to lowercase as well
          IMAGE_TAG_LOWER=$(echo "$IMAGE_TAG" | tr '[:upper:]' '[:lower:]')
          
          if [[ ! "$IMAGE_TAG_LOWER" =~ ^[a-z0-9._-]+$ ]]; then
            echo "âŒ Invalid tag format: $IMAGE_TAG_LOWER"
            exit 1
          fi
          
          echo "image_tag=$IMAGE_TAG_LOWER" >> $GITHUB_OUTPUT
          echo "âœ… Tag validated: $IMAGE_TAG_LOWER"

      - name: Check if image tag exists in registry
        id: check-tag
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.prepare.outputs.image_name }}"
          IMAGE_TAG="${{ steps.validate.outputs.image_tag }}"
          REPO_OWNER="${{ steps.prepare.outputs.repo_owner }}"
          FULL_IMAGE="${{ env.REGISTRY }}/${REPO_OWNER}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "ðŸ” Checking registry for: $FULL_IMAGE"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://${{ env.REGISTRY }}/v2/${REPO_OWNER}/${IMAGE_NAME}/manifests/${IMAGE_TAG}")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Image tag already exists in registry"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ Image tag not found in registry (HTTP $RESPONSE)"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip notification
        if: steps.check-tag.outputs.skip == 'true'
        run: |
          echo "â­ï¸ Skipping build for ${{ steps.prepare.outputs.image_name }}:${{ steps.validate.outputs.image_tag }}"
          echo "Image already exists in registry"

      - name: Set up Docker Buildx
        if: steps.check-tag.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log into registry ${{ env.REGISTRY }}
        if: steps.check-tag.outputs.skip != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        if: steps.check-tag.outputs.skip != 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.prepare.outputs.repo_owner }}/${{ steps.prepare.outputs.image_name }}
          tags: |
            type=raw,value=${{ steps.validate.outputs.image_tag }}
            type=raw,value=latest

      - name: Build and push Docker image
        if: steps.check-tag.outputs.skip != 'true'
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: ./images/${{ matrix.image }}
          file: ./images/${{ matrix.image }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ steps.prepare.outputs.image_name }}
          cache-to: type=gha,mode=max,scope=${{ steps.prepare.outputs.image_name }}

      - name: Install cosign
        if: steps.check-tag.outputs.skip != 'true'
        uses: sigstore/cosign-installer@v3.5.0
        with:
          cosign-release: 'v2.2.4'

      - name: Sign the published Docker image
        if: steps.check-tag.outputs.skip != 'true'
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
          DIGEST: ${{ steps.build-and-push.outputs.digest }}
        run: |
          echo "ðŸ” Signing images..."
          echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary for ${{ steps.prepare.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-tag.outputs.skip }}" = "true" ]; then
            echo "â­ï¸ **Status:** Skipped (image already exists)" >> $GITHUB_STEP_SUMMARY
            echo "- **Image:** ${{ steps.prepare.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** ${{ steps.validate.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.build-and-push.outcome }}" = "success" ]; then
            echo "âœ… **Status:** Successfully built and pushed" >> $GITHUB_STEP_SUMMARY
            echo "- **Image:** ${{ steps.prepare.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** ${{ steps.validate.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Digest:** ${{ steps.build-and-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Full Image:** ${{ env.REGISTRY }}/${{ steps.prepare.outputs.repo_owner }}/${{ steps.prepare.outputs.image_name }}:${{ steps.validate.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Build failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Image:** ${{ steps.prepare.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    needs: [discover, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Workflow summary
        run: |
          echo "## Workflow Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All image builds have been processed." >> $GITHUB_STEP_SUMMARY
